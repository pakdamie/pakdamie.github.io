{
  "hash": "b198b474232217d5da6265510cecfd36",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Stochastic SIS model\"\nsubtitle: \"Learning for me\"\nauthor: \"Damie Pak\"\nimage: \"death.jpg\"\ncategories: [\"Tutorial\"]\ntoc: true\ndraft: false\ncache: true\neditor_options: \n  chunk_output_type: console\nfreeze: auto\ntitle-block-banner: true\n---\n\n\n\n\n\nWORK IN PROGRESS\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(igraph)\nlibrary(ggplot2)\nlibrary(ggnetwork)\nlibrary(dplyr)\nlibrary(gganimate)\n```\n:::\n\n\n\n\n\nThis is for my sake of actually learning how to make a stochastic SIS model.\n\n## The Math\n\nAssume we have an SIS model (Susceptible to Infected to Susceptible). Assuming we have constant $N$ individuals in the population (no demography), there can be $n$ number of infectious individuals. Therefore, for the susceptible population, $S = N- n$ and for the infectious population $I = n$ .\n\nIn a stochastic, markovian model. We can have individuals of both state transition like so:\n\n$$\n(S,I) \\rightarrow (S-1, I + 1) ,\n$$\n\nwhere a susceptible individual becomes infected with the parameter $\\beta$ or:\n\n$$\n(S,I) \\rightarrow (S+1, I -1),\n$$\n\nwhere infected individuals recover at rate $\\gamma$.\n\nFor stochastic modeling, we use something called a master equation that can tell us how the state distribution varies over time (how individuals \"jump\" from one state to another).\n\nIf we're interested in\n\nAssuming, we are interested in looking the probability where $n$ individuals are infected and we are interested what the next time step could be. We call this $p_n (t)$.\n\nWell, it could be that in a state where $n-1$ individuals are infected, the infected individual infected one of the susceptible. This means that\n\n$$\np_{n-1} \\beta(n-1)(N-(n-1)) \\Delta t\n$$\n\nin English, the probability of being in the state where there are $n-1$ infectious individuals that will then infect another individual which is the number of susceptibles ($N-(n-1)$) and infectious individuals ($n-1$).\n\nNow it could be possible that there is the probability that susceptible individuals do not get infected and the infectious individuals have not recovered yet.\n\nThis means that the probability of no individual being infected is \\$ 1- P(an individual being infected)\\$, such that:\n\n\\$\\$ p_n(1- (\\beta n(N-n)))\n\n\\$\\$ And individuals that do not recover is:\n\n$$\np_n(1-(\\beta n(N-n)+\\gamma n)) \\Delta t\n$$ Then we can have an individual recover:\n\n$$\np_{n+1} = \\gamma (n+1) \\Delta t\n$$ Putting this all together:\n\n$$\np_n(t + \\Delta t) = p_{n-1} \\beta(n-1)(N-(n-1)) \\Delta t+\np_n(1-(\\beta n(N-n)-\\gamma n)) \\Delta t + \n\\gamma (n+1) \\Delta t\n$$ We notice that we can convert this into a continous form by noting the $p_n$ in the middle term.\n\n$$\np_n(t + \\Delta t) - p_n(t)= p_{n-1} \\beta(n-1)(N-(n-1)) \\Delta t\n-p_n(\\beta n(N-n)+\\gamma n)) \\Delta t + \n\\gamma (n+1) \\Delta t\n$$ We can then divide everything by the time step $\\Delta t$:\n\n$$\n\\frac{p_n(t + \\Delta t) - p_n(t)}{\\Delta t}= p_{n-1} \\beta(n-1)(N-(n-1)) \n-p_n(\\beta n(N-n)+\\gamma n)) + \n\\gamma (n+1) \n$$ And as $\\Delta t$ approaches infinity, we then have\n\n$$\n\\frac{dP_n(t)}{dt} =  p_{n-1} \\beta(n-1)(N-(n-1)) \n-p_n(\\beta n(N-n)+\\gamma n)) + \n\\gamma (n+1) \n$$ With this master equation, we can simulate the model.\n\n## Code\n\nThe Gillepsie method takes that master equation. Where we first simulate the time to the next event and figure out which event has occcured (infection or recovery). We use something called a Poisson process where we say there is a rate at which events happen but we want it to be random AND independent. The rate at which something happens in the system is what we described with the master equation. The poisson process is also useful because we also know the time to events.\n\nPoisson (P_n) then the exponential waiting time is (1- exp(P_n)t).\n\nWe can use a uniform distribution through something called:Inverse Transform Sampling.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We create a susceptible and infectious vector and we will simulate for a 100 time steps\nS = matrix(c(10,rep(0,100-1)), nrow = 100, ncol = 1 ) #susceptible individuals \nI = matrix(c(2,rep(0,100-1)), nrow = 100,ncol = 1) #infectious individuals\n```\n:::\n\n\n\n\n\nHere are the parameters:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta = 0.1\ngamma = 1/3\ntime = 0 \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (i in seq(1,100)){\n  \n  infection = beta * S[i] * I[i]\n  recovery = gamma * I[i]\n  total_rate = infection + recovery\n  \n  random_number<- runif(2,min=0,max=1)\n  \n  \n  tau <- (1 /total_rate) * log(1 / random_number[1])\n  \n  time = time +  tau\n  \n  rate_of_interest <- infection/total_rate\n  \n  if(random_number[2] < rate_of_interest){\n    \n    S[i+1] = S[i] - 1 \n    I[i+1] = I[i] + 1\n  }\n  else{\n     S[i+1] = S[i] + 1 \n     I[i+1] = I[i] - 1  \n    \n  }\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfull_model<- cbind.data.frame(time = seq(0,100),Sus = S, Infect = I)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(full_model, aes(x = time, y = S))+ geom_line(color = 'red') + \n  geom_line(aes(x = time, y= I),color = 'black')+theme_bw()\n```\n\n::: {.cell-output-display}\n![](stochastic_sis_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Doing this in a network\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#let's say there are 10 individuals \n\ngraph = erdos.renyi.game(25,50 , type = \"gnm\", directed = FALSE)\nV(graph)$label <- seq(1,25)\nstate = rep(\"S\",25)\npatient_zero = sample(seq(1,25),1)\nstate[patient_zero] <- \"I\"\n\n time_list = NULL\nfor (i in seq(1,100)){\n\n  infection_propensity = NULL\n  recovery_propensity = NULL\n\n  inf_node <- which(state == \"I\")\n    \n  \n    recovery_propensity <- list(cbind(n=  inf_node,rate=gamma))\n    neighbors <-  neighbors(graph, inf_node )\n     \n     for (n in neighbors){\n        if (state[n] == \"S\") {\n         infection_propensity[[n]] <- cbind(n,rate=beta)\n       \n        }\n       \n     }\n    \n    \n    full_infect_rate <- cbind.data.frame(do.call(rbind,infection_propensity),status = 'infect')\n    full_recovery_rate <- cbind.data.frame(do.call(rbind,recovery_propensity), status = 'recover')\n\n    events = rbind(full_infect_rate, full_recovery_rate)\n    \n     \n    total_rate <- sum(events$rate)\n    \n     random <- runif(2)\n    \n      tau <- -log(random[1]) / total_rate\n     \n      cumulative_rate <- 0\n      \n      selected_event <- NULL\n      for (event in seq(1,nrow(events))) {\n      cumulative_rate <- cumulative_rate + events$rate[event]\n      \n      if (random[2] * total_rate <= cumulative_rate) {\n        selected_event <- event\n        break\n      }\n    }\n       time <- time + tau\n      \n      if (!is.null(selected_event)) {\n      node <- selected_event\n      if (state[node] == \"I\") {\n        # Recovery event\n        state[node] <- \"S\"\n      } else {\n        # Infection event\n        state[node] <- \"I\"\n      }\n    }\n \n       time_list[[i]] = cbind.data.frame(time,state,node = seq(1,100))\n}      \n\n full_time_list <- do.call(rbind, \n time_list )  \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfull_graph<- fortify(graph)\nfull_spatial <-full_graph[,c('x','y','label')]\nfull_spatial<- full_spatial[!(duplicated(full_spatial)), ]\n\neep<- left_join( full_time_list ,full_spatial, by = join_by(node==label))\n\ngg_anim <- ggplot(data=full_graph)+\n  geom_edges(aes(x = x, y = y, xend = xend, yend = yend),color = \"black\")+\n  geom_point(data = eep, aes(x =x, y=y,color = state),size =10)+\n   transition_states(time,  state_length = 1)+\n  enter_fade() + \n  exit_shrink() +\n  ease_aes('sine-in-out',interval = 0.001)+theme_void()\n\n  animate(gg_anim, fps=5)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\nRemoved 75 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](stochastic_sis_files/figure-html/unnamed-chunk-8-1.gif)\n:::\n\n```{.r .cell-code}\n anim_save ('gganim.gif')\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}